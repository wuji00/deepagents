# Main CI workflow for Deep Agents monorepo
#
# Runs on every pull request:
# - Linting for changed packages
# - Unit Tests for changed packages
#
# Only packages with changes are tested. SDK changes also trigger CLI tests.
# Pushes to master and workflow changes run full CI.

name: "ğŸ”§ CI"

on:
  push:
    branches: [master]
  pull_request:
  merge_group:

# Cancel redundant workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  UV_NO_SYNC: "true"

jobs:
  # Detect which packages have changes
  changes:
    name: "ğŸ” Detect Changes"
    runs-on: ubuntu-latest
    outputs:
      deepagents: ${{ steps.filter.outputs.deepagents }}
      cli: ${{ steps.filter.outputs.cli }}
      harbor: ${{ steps.filter.outputs.harbor }}
      daytona: ${{ steps.filter.outputs.daytona }}
      modal: ${{ steps.filter.outputs.modal }}
      runloop: ${{ steps.filter.outputs.runloop }}
    steps:
      - name: "ğŸ“‹ Checkout Code"
        uses: actions/checkout@v6

      - name: "ğŸ” Check for changes"
        uses: dorny/paths-filter@v3
        id: filter
        with:
          # Each package filter includes workflow/action paths so that CI
          # infrastructure changes are validated against all packages.
          filters: |
            deepagents:
              - 'libs/deepagents/**'
              - '.github/workflows/ci.yml'
              - '.github/workflows/_lint.yml'
              - '.github/workflows/_test.yml'
              - '.github/actions/**'
            cli:
              - 'libs/cli/**'
              - 'libs/deepagents/**'
              - '.github/workflows/ci.yml'
              - '.github/workflows/_lint.yml'
              - '.github/workflows/_test.yml'
              - '.github/actions/**'
            harbor:
              - 'libs/harbor/**'
              - '.github/workflows/ci.yml'
              - '.github/workflows/_lint.yml'
              - '.github/workflows/_test.yml'
              - '.github/actions/**'
            daytona:
              - 'libs/partners/daytona/**'
              - '.github/workflows/ci.yml'
              - '.github/workflows/_lint.yml'
              - '.github/workflows/_test.yml'
              - '.github/actions/**'
            modal:
              - 'libs/partners/modal/**'
              - '.github/workflows/ci.yml'
              - '.github/workflows/_lint.yml'
              - '.github/workflows/_test.yml'
              - '.github/actions/**'
            runloop:
              - 'libs/partners/runloop/**'
              - '.github/workflows/ci.yml'
              - '.github/workflows/_lint.yml'
              - '.github/workflows/_test.yml'
              - '.github/actions/**'

  # Run linting on changed packages
  lint-deepagents:
    name: "ğŸ§¹ Lint deepagents"
    needs: changes
    if: needs.changes.outputs.deepagents == 'true' || github.event_name == 'push'
    uses: ./.github/workflows/_lint.yml
    with:
      working-directory: "libs/deepagents"
      python-version: "3.11"

  lint-cli:
    name: "ğŸ§¹ Lint cli"
    needs: changes
    if: needs.changes.outputs.cli == 'true' || github.event_name == 'push'
    uses: ./.github/workflows/_lint.yml
    with:
      working-directory: "libs/cli"
      python-version: "3.11"

  lint-harbor:
    name: "ğŸ§¹ Lint harbor"
    needs: changes
    if: needs.changes.outputs.harbor == 'true' || github.event_name == 'push'
    uses: ./.github/workflows/_lint.yml
    with:
      working-directory: "libs/harbor"
      python-version: "3.14"

  lint-daytona:
    name: "ğŸ§¹ Lint daytona"
    needs: changes
    if: needs.changes.outputs.daytona == 'true' || github.event_name == 'push'
    uses: ./.github/workflows/_lint.yml
    with:
      working-directory: "libs/partners/daytona"
      python-version: "3.11"

  lint-modal:
    name: "ğŸ§¹ Lint modal"
    needs: changes
    if: needs.changes.outputs.modal == 'true' || github.event_name == 'push'
    uses: ./.github/workflows/_lint.yml
    with:
      working-directory: "libs/partners/modal"
      python-version: "3.11"

  lint-runloop:
    name: "ğŸ§¹ Lint runloop"
    needs: changes
    if: needs.changes.outputs.runloop == 'true' || github.event_name == 'push'
    uses: ./.github/workflows/_lint.yml
    with:
      working-directory: "libs/partners/runloop"
      python-version: "3.11"

  # Run unit tests on changed packages
  test-deepagents:
    name: "ğŸ§ª Test deepagents"
    needs: changes
    if: needs.changes.outputs.deepagents == 'true' || github.event_name == 'push'
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]
      fail-fast: false
    uses: ./.github/workflows/_test.yml
    with:
      working-directory: "libs/deepagents"
      python-version: ${{ matrix.python-version }}

  test-cli:
    name: "ğŸ§ª Test cli"
    needs: changes
    if: needs.changes.outputs.cli == 'true' || github.event_name == 'push'
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]
      fail-fast: false
    uses: ./.github/workflows/_test.yml
    with:
      working-directory: "libs/cli"
      python-version: ${{ matrix.python-version }}

  test-harbor:
    name: "ğŸ§ª Test harbor"
    needs: changes
    if: needs.changes.outputs.harbor == 'true' || github.event_name == 'push'
    strategy:
      matrix:
        python-version: ["3.12", "3.13", "3.14"]
      fail-fast: false
    uses: ./.github/workflows/_test.yml
    with:
      working-directory: "libs/harbor"
      python-version: ${{ matrix.python-version }}

  test-daytona:
    name: "ğŸ§ª Test daytona"
    needs: changes
    if: needs.changes.outputs.daytona == 'true' || github.event_name == 'push'
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]
      fail-fast: false
    uses: ./.github/workflows/_test.yml
    with:
      working-directory: "libs/partners/daytona"
      python-version: ${{ matrix.python-version }}

  test-modal:
    name: "ğŸ§ª Test modal"
    needs: changes
    if: needs.changes.outputs.modal == 'true' || github.event_name == 'push'
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]
      fail-fast: false
    uses: ./.github/workflows/_test.yml
    with:
      working-directory: "libs/partners/modal"
      python-version: ${{ matrix.python-version }}

  test-runloop:
    name: "ğŸ§ª Test runloop"
    needs: changes
    if: needs.changes.outputs.runloop == 'true' || github.event_name == 'push'
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]
      fail-fast: false
    uses: ./.github/workflows/_test.yml
    with:
      working-directory: "libs/partners/runloop"
      python-version: ${{ matrix.python-version }}

  # Final status check - ensures all jobs passed
  ci_success:
    name: "âœ… CI Success"
    needs:
      - changes
      - lint-deepagents
      - lint-cli
      - lint-harbor
      - lint-daytona
      - lint-modal
      - lint-runloop
      - test-deepagents
      - test-cli
      - test-harbor
      - test-daytona
      - test-modal
      - test-runloop
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ‰ All Checks Passed"
        run: |
          # Get all job results (excluding 'changes' which always succeeds)
          results='${{ toJSON(needs.*.result) }}'
          echo "Job results: $results"

          # Check for failures or cancellations
          if echo "$results" | grep -qE '"failure"|"cancelled"'; then
            echo "Some jobs failed or were cancelled"
            exit 1
          fi

          echo "All required checks passed (skipped jobs are OK)"
          exit 0
