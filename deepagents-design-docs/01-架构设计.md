# DeepAgents 架构设计文档

## 1. 项目概述

DeepAgents 是一个基于 LangGraph 的 "batteries-included" Agent 框架，提供开箱即用的 Agent 功能，包括任务规划、文件操作、子代理委派和上下文管理。

### 1.1 核心设计理念

- **开箱即用**：无需手动配置 prompts、tools 和 context management
- **可扩展性**：通过 Backend 和 Middleware 系统实现功能扩展
- **生产就绪**：基于 LangGraph 构建，支持流式、持久化和检查点功能
- **模型无关**：支持 Claude、OpenAI、Google 等任何 LangChain 兼容模型

### 1.2 架构分层

```
┌─────────────────────────────────────────────────────────────┐
│                    Agent 应用层                              │
│  (CLI、ACPServer、第三方集成)                                  │
├─────────────────────────────────────────────────────────────┤
│                    DeepAgent SDK                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  create_deep_agent()                                  │  │
│  │  - 模型配置                                            │  │
│  │  - 工具注册                                            │  │
│  │  - Middleware 组装                                     │  │
│  └───────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                    Middleware 层                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐    │
│  │ TodoList │ │Filesystem│ │SubAgent  │ │Summarization │    │
│  │Middleware│ │Middleware│ │Middleware│ │ Middleware   │    │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────┘    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                      │
│  │  Skills  │ │  Memory  │ │  Patch   │                      │
│  │Middleware│ │Middleware│ │ToolCalls │                      │
│  └──────────┘ └──────────┘ └──────────┘                      │
├─────────────────────────────────────────────────────────────┤
│                    Backend 层                                │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌──────────┐  │
│  │StateBackend│ │Filesystem  │ │StoreBackend│ │Sandbox   │  │
│  │(内存状态)   │ │Backend     │ │(持久化存储) │ │Providers │  │
│  └────────────┘ └────────────┘ └────────────┘ └──────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 2. 核心组件

### 2.1 入口函数：create_deep_agent()

**文件位置**：`deepagents/graph.py`

`create_deep_agent()` 是 DeepAgents 的核心入口函数，负责组装和配置一个完整的 Agent。

#### 主要功能

1. **模型初始化**
   - 默认使用 Claude Sonnet 4.5
   - 支持通过字符串快速切换模型（如 `"openai:gpt-4o"`）

2. **默认中间件栈**
   DeepAgent 包含以下标准中间件（按顺序执行）：
   ```
   1. TodoListMiddleware       - 任务规划与管理
   2. MemoryMiddleware (可选)  - 记忆加载
   3. SkillsMiddleware (可选)  - 技能系统
   4. FilesystemMiddleware     - 文件操作
   5. SubAgentMiddleware       - 子代理委派
   6. SummarizationMiddleware  - 上下文压缩
   7. AnthropicPromptCachingMiddleware - Prompt 缓存优化
   8. PatchToolCallsMiddleware - Tool 调用修复
   9. HumanInTheLoopMiddleware (可选) - 人工审核
   ```

3. **子代理配置**
   - 自动创建通用子代理（general-purpose）
   - 支持用户自定义子代理
   - 子代理继承父代理的默认配置

### 2.2 内置工具集

DeepAgents 默认提供以下工具：

| 工具名称 | 功能描述 | 所属 Middleware |
|---------|---------|----------------|
| `write_todos` / `read_todos` | 任务规划与进度跟踪 | TodoListMiddleware |
| `ls` | 列出目录文件 | FilesystemMiddleware |
| `read_file` | 读取文件内容（支持分页） | FilesystemMiddleware |
| `write_file` | 写入新文件 | FilesystemMiddleware |
| `edit_file` | 编辑文件内容（字符串替换） | FilesystemMiddleware |
| `glob` | 文件模式匹配 | FilesystemMiddleware |
| `grep` | 文件内容搜索 | FilesystemMiddleware |
| `execute` | 执行 shell 命令（需 Sandbox 后端） | FilesystemMiddleware |
| `task` | 委派任务给子代理 | SubAgentMiddleware |

## 3. 数据流架构

### 3.1 请求处理流程

```
User Input
    │
    ▼
┌─────────────────┐
│  System Prompt  │ ◄── 整合 Base Prompt + 用户自定义 + Middleware 注入
│   Assembly      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Before Agent   │ ◄── TodoListMiddleware、MemoryMiddleware、SkillsMiddleware
│   Hooks         │     加载记忆、技能到 State
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Before Model   │ ◄── SummarizationMiddleware 检查并触发摘要
│   Processing    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  LLM Model Call │ ◄── 调用语言模型生成响应/工具调用
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Tool Execution │ ◄── FilesystemMiddleware、SubAgentMiddleware 执行工具
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Wrap Tool Call  │ ◄── 处理大工具结果（转存到文件系统）
└────────┬────────┘
         │
         ▼
    Response
```

### 3.2 State 管理

DeepAgents 使用 LangGraph 的 StateGraph 进行状态管理：

```python
# 核心 State 结构
class AgentState:
    messages: list[AnyMessage]          # 对话历史
    todos: list[dict]                   # 待办事项（TodoListMiddleware）
    files: dict[str, FileData]          # 文件内容（FilesystemMiddleware）
    skills_metadata: list[SkillMetadata] # 技能元数据（SkillsMiddleware）
    memory_contents: dict[str, str]      # 记忆内容（MemoryMiddleware）
```

## 4. 模块关系图

```
                    ┌──────────────────┐
                    │   create_deep    │
                    │     _agent()     │
                    └────────┬─────────┘
                             │
           ┌─────────────────┼─────────────────┐
           │                 │                 │
           ▼                 ▼                 ▼
    ┌────────────┐   ┌────────────┐   ┌────────────┐
    │   Model    │   │   Tools    │   │ Middleware │
    │  Config    │   │   Setup    │   │   Stack    │
    └────────────┘   └────────────┘   └─────┬──────┘
                                            │
                    ┌───────────────────────┼───────────────────────┐
                    │                       │                       │
                    ▼                       ▼                       ▼
            ┌──────────────┐      ┌──────────────┐      ┌──────────────┐
            │   Backend    │      │   Standard   │      │   Custom     │
            │   System     │      │ Middlewares  │      │ Middlewares  │
            └──────────────┘      └──────────────┘      └──────────────┘
                    │                       │
        ┌───────────┼───────────┐           │
        │           │           │           │
        ▼           ▼           ▼           ▼
┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐
│  State    │ │Filesystem │ │  Store    │ │   Todo    │
│  Backend  │ │  Backend  │ │  Backend  │ │   List    │
└───────────┘ └───────────┘ └───────────┘ └───────────┘
                                              │
                                              ▼
                                        ┌───────────┐
                                        │ Filesystem│
                                        │  SubAgent │
                                        │Summarization
                                        │   Skills  │
                                        │   Memory  │
                                        └───────────┘
```

## 5. 配置与扩展点

### 5.1 主要配置选项

```python
create_deep_agent(
    model="openai:gpt-4o",              # 模型配置
    tools=[custom_tool],                 # 自定义工具
    system_prompt="Custom prompt",       # 自定义系统提示
    middleware=[custom_middleware],      # 额外中间件
    subagents=[research_agent],          # 自定义子代理
    skills=["/skills/custom"],           # 技能路径
    memory=["/memory/AGENTS.md"],        # 记忆文件
    backend=FilesystemBackend("/data"),  # 后端配置
    interrupt_on={"edit_file": True},    # 人工审核点
)
```

### 5.2 扩展机制

1. **自定义 Backend**：实现 `BackendProtocol` 接口
2. **自定义 Middleware**：继承 `AgentMiddleware` 基类
3. **自定义 SubAgent**：定义 `SubAgent` 或 `CompiledSubAgent` 规范
4. **自定义 Tools**：使用 LangChain 的 `@tool` 装饰器

## 6. 关键技术决策

### 6.1 为什么选择 Middleware 模式？

- **关注点分离**：每个 Middleware 负责单一功能
- **可组合性**：Middleware 可以堆叠和组合
- **可测试性**：单个 Middleware 可以独立测试
- **可扩展性**：新功能通过添加 Middleware 实现

### 6.2 Backend 抽象的价值

- **存储无关**：文件可以存储在内存、磁盘、数据库或远程沙箱
- **执行隔离**：支持本地执行和沙箱执行的无缝切换
- **统一接口**：所有存储后端提供一致的文件操作 API

### 6.3 子代理设计原则

- **上下文隔离**：每个子代理有独立的上下文窗口
- **并行执行**：支持同时启动多个子代理
- **结果聚合**：子代理结果以 ToolMessage 形式返回
- **状态继承**：子代理可以选择性地继承父代理状态

---

*文档生成时间：2025年2月*
*基于 DeepAgents 源码分析*
